<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>BUKABOX ‚Äî Financial Intelligence Dashboard v4.3-Sync</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h1>BUKABOX ‚Äî Financial Intelligence Dashboard v4.3-Sync</h1>
  <nav>
    <a href="{{ url_for('index') }}" class="active">üè† Dashboard</a>
    <a href="{{ url_for('investment_panel') }}">üíπ Investment</a>
  </nav>
  <p>{{ today }}</p>
</header>


<div id="cardContainer" class="container masonry">
  <div class="col" id="col1"></div>
  <div class="col" id="col2"></div>
</div>

  <!-- SECTION 1 ‚Äì INCOME -->
  <section id="income-overview" class="card">
    <div class="block-chart">
    <div class="left">
      <canvas id="incomeChart"></canvas>
    </div>

    <div class="right">
      <h2>Revenue Streams</h2>
      <form method="post" action="{{ url_for('add_income') }}">
        <div class="grid2">
          <input type="date" name="date" value="{{ today }}">
          <input type="text" name="stream" placeholder="Nama stream baru">
          <input type="text" name="amount" class="money" autocomplete="off" placeholder="Jumlah (IDR)">
          <input type="text" name="note" placeholder="Catatan">
          <button type="submit">Tambah</button>
        </div>
      </form>
      <form action="/cancel_last/income" method="POST" style="margin-top:8px;">
        <button type="submit" class="cancel-btn">‚ü≤ Batalkan Input Terakhir</button>
      </form>
      
    </div>
  </div>
  <table>
        <tr><th>Stream</th><th>Amount</th><th>Note</th></tr>
        {% for i in income|reverse %}
        <tr><td>{{ i.stream }}</td><td>{{ i.amount|idr }}</td><td>{{ i.note }}</td></tr>
        {% endfor %}
      </table>
  </section>

  <!-- SECTION 2 ‚Äì CASHFLOW -->
<section id="cashflow" class="card">
  <div class="left">
    <h2>Cashflow {{ today[:7] }}</h2>
    <div class="cash-block"><h3>Income : {{ total_income|idr }}</h3></div>
    <div class="cash-block">
      <h3>Expenses : {{ total_expense|idr }}</h3>
      <button onclick="toggleDetail('exp-table-box')">Detail</button>
    </div>
    <div class="summary-box buffer">
      <p><strong>Buffer (Sisa Bulan Ini):</strong>
        <span class="{% if buffer_balance < 0 %}negative{% else %}positive{% endif %}">
          {{ buffer_balance | currency_format }}
        </span>
      </p>
    </div>
  </div>

  <div class="right">
    <canvas id="cashflowChart"></canvas>
    
  </div>

  <!-- ======= TABEL EXPENSE (area bawah merah) ======= -->
  <div id="exp-table-box" class="expense-box">
    <h3>Catat Pengeluaran Baru</h3>

  <form method="post" action="{{ url_for('add_expense') }}">
    <div class="grid2">
      <input type="date" name="date" value="{{ today }}">
      <input type="text" name="category" placeholder="Kategori (misal: Makan, Transport, dll)" required>
      <input type="text" name="amount" class="money" autocomplete="off" placeholder="Jumlah (IDR)" required>
      <input type="text" name="note" placeholder="Catatan opsional">
      <button type="submit">Tambah</button>
    </div>
  </form>

  <form action="/cancel_last/expense" method="POST" style="margin-top:8px;">
    <button type="submit" class="cancel-btn">‚ü≤ Batalkan Input Terakhir</button>
  </form>

    <table class="expense-table full-width">
      <thead>
        <tr>
          <th style="width:100px;">Tanggal</th>
          <th style="width:180px;">Kategori</th>
          <th style="width:150px;">Jumlah (IDR)</th>
          <th>Catatan</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cashflow if c.type == 'expense' %}
        <tr>
          <td>
            {% if c.date %}
              {{ c.date[8:10] }}/{{ c.date[5:7] }}/{{ c.date[2:4] }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ c.category }}</td>
          <td>{{ c.amount | idr }}</td>
          <td>{{ c.note }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- üí∞ Dana Darurat -->
<section id="emergency-fund" class="card full-width">
  <h2>üí∞ Dana Darurat</h2>
  <form method="post" action="{{ url_for('add_emergency') }}">
    <input type="date" name="date" value="{{ today }}">
    <input type="text" name="amount" class="money" placeholder="Jumlah (IDR)">
    <input type="text" name="note" placeholder="Catatan">
    <button type="submit" class="btn-green">Tambah</button>
  </form>

  <form method="post" action="{{ url_for('reduce_emergency') }}" style="margin-top:10px;">
    <input type="date" name="date" value="{{ today }}">
    <input type="text" name="amount" class="money" placeholder="Kurangi (IDR)">
    <input type="text" name="note" placeholder="Catatan pengeluaran">
    <button type="submit" class="btn-red">Kurangi</button>
  </form>

  <hr>

  <div class="emergency-summary">
    <p><strong>Total terkumpul:</strong> {{ total_emergency | currency_format }}</p>
    <p>Target 1: Rp {{ target1 | currency_format }}</p>
    
    <!-- Progress 1: terhadap target1 -->
<div class="progress-container">
  <div class="progress-bar">
    <div class="progress-fill" 
         style="width: {{ ((total_emergency / target1) * 100) if target1 else 0 }}%;
                background: linear-gradient(90deg, #f4b942, #f77f00);">
      {{ ((total_emergency / target1) * 100) | round(1) }}%
    </div>
  </div>
  <p style="font-size:12px;color:#777;margin:4px 0 0 0;">Progress 1 dari {{ target1 | currency_format }}</p>
</div>
    <p>Target 2: Rp {{ target2 | currency_format }}</p>
<!-- Progress 2: terhadap target2 -->
<div class="progress-container">
  <div class="progress-bar">
    <div class="progress-fill" 
         style="width: {{ ((total_emergency / target2) * 100) if target2 else 0 }}%;
                background: linear-gradient(90deg, #6fbf73, #2b9348);">
      {{ ((total_emergency / target2) * 100) | round(1) }}%
    </div>
  </div>
  <p style="font-size:12px;color:#777;margin:4px 0 0 0;">Progress 2 dari {{ target2 | currency_format }}</p>
</div>

  </div>

  <table class="emergency-table">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Nominal</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody>
      {% for e in emergency %}
      <tr class="{% if e.amount < 0 %}negative{% else %}positive{% endif %}">
        <td>{{ e.date }}</td>
        <td>{{ e.amount | currency_format }}</td>
        <td>{{ e.note }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>


  <!-- SECTION 3 ‚Äì GLOBAL INVESTMENT OVERVIEW -->
  <section id="invest-overview" class="card">
    <div class="left"><canvas id="investChart"></canvas></div>
    <div class="right">
      <h2>Investment Allocation</h2>
      <table>
        <tr><th>Asset Class</th><th>Total (IDR)</th></tr>
        <tr onclick="openDetail('crypto')"><td>Crypto</td><td class="clickable">{{ inv_crypto|idr }}</td></tr>
        <tr onclick="openDetail('gold')"><td>Gold</td><td class="clickable">{{ inv_gold|idr }}</td></tr>
        <tr onclick="openDetail('land')"><td>Land</td><td class="clickable">{{ inv_land|idr }}</td></tr>
        <tr onclick="openDetail('business')"><td>Business</td><td class="clickable">{{ inv_business|idr }}</td></tr>
        <tr onclick="openDetail('stock')"><td>Stock</td><td class="clickable">{{ inv_stock|idr }}</td></tr>
      </table>
    </div>
  </section>



<footer><p>BUKABOX Studio ‚Äî Machine Uang Progresif v4.3-Sync</p>
<form action="{{ url_for('save_history') }}" method="get" style="margin-top:20px;">
  <button type="submit" style="padding:8px 12px;">üíæ Simpan Snapshot Bulanan</button>

  <form action="{{ url_for('rollover_action') }}" method="POST" style="margin-top:20px;">
  <button type="submit" class="btn-warning">
    üîÑ Tutup Bulan (Rollover)
  </button>
</form>
</form>
</form>

</footer>

<script>
function calcCryptoAmount(){
  const idr=parseFloat(document.getElementById('crypto_idr').value.replace(/\./g,''))||0;
  const price=parseFloat(document.getElementById('crypto_price').value.replace(/\./g,''))||0;
  document.getElementById('crypto_total').value=price>0?(idr/price).toFixed(6):0;
}
function calcGoldGram(){
  const idr=parseFloat(document.getElementById('gold_idr').value.replace(/\./g,''))||0;
  const price=parseFloat(document.getElementById('gold_price').value.replace(/\./g,''))||0;
  document.getElementById('gold_total').value=price>0?(idr/price).toFixed(2):0;
}
function calcStockLot(){
  const idr=parseFloat(document.getElementById('stock_idr').value.replace(/\./g,''))||0;
  const price=parseFloat(document.getElementById('stock_price').value.replace(/\./g,''))||0;
  document.getElementById('stock_total').value=price>0?(idr/(price*100)).toFixed(2):0;
}
function calcLandValue(){
  const ubin=parseFloat(document.getElementById('land_ubin').value)||0;
  const price=parseFloat(document.getElementById('land_price').value.replace(/\./g,''))||0;
  document.getElementById('land_total').value=(ubin*price).toFixed(0);
}
function toggleDetail(id){document.getElementById(id).classList.toggle("open");}
function openDetail(t){document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
  const el=document.getElementById(t+'-detail');if(el){el.classList.add('active');}
  document.getElementById('asset-detail').scrollIntoView({behavior:'smooth'});}
document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("input.money").forEach(inp=>{
  inp.addEventListener("input",()=>{const pos=inp.selectionStart;const val=inp.value.replace(/\D/g,"");
  const fmt=val.replace(/\B(?=(\d{3})+(?!\d))/g,".");inp.value=fmt;
  const newPos=pos+(fmt.length-val.length);inp.setSelectionRange(newPos,newPos);});
  const form=inp.closest("form");if(form){form.addEventListener("submit",()=>{inp.value=inp.value.replace(/\./g,"");});}});});
</script>
<script>
const commonOpt = {
  responsive:true,
  maintainAspectRatio:true,
  aspectRatio:1,
  plugins:{
    legend:{ position:'bottom', labels:{ font:{size:13}, color:'#333' } },
    tooltip:{
      callbacks:{
        label:function(context){
          const dataset=context.dataset;
          const total=dataset.data.reduce((a,b)=>a+b,0);
          const val=dataset.data[context.dataIndex];
          const percent=((val/total)*100).toFixed(1);
          return `${context.label}: ${percent}%`;
        }
      }
    }
  }
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Income Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
new Chart(document.getElementById('incomeChart'),{
  type:'doughnut',
  data:{
    labels:[{% for i in income %}'{{ i.stream }}',{% endfor %}],
    datasets:[{
      data:[{% for i in income %}{{ i.amount }},{% endfor %}],
      backgroundColor:['#B8E4C9','#A5C8E4','#F4C7B8','#EAD1DC'],
      cutout:'60%'
    }]
  },
  options:commonOpt
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Cashflow Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
new Chart(document.getElementById('cashflowChart'), {
  type: 'pie',
  data: {
    labels: ['Income', 'Expense', 'Investment', 'Buffer'],
    datasets: [{
      data: [{{ total_income }}, {{ total_expense }}, {{ total_invest_month }}, {{ buffer_balance }}],
      backgroundColor: ['#A5C8E4','#F4C7B8','#B8E4C9','#C6E2B3']
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    aspectRatio: 1,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: function(context) {
            const total = context.dataset.data.reduce((a,b)=>a+b,0);
            const value = context.raw;
            const percent = ((value/total)*100).toFixed(1);
            // format angka menjadi ribuan dengan titik
            const formatted = value.toLocaleString('id-ID');
            return `${context.label}: Rp ${formatted} (${percent}%)`;
          }
        }
      }
    }
  }
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Investment Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
new Chart(document.getElementById('investChart'),{
  type:'doughnut',
  data:{
    labels:['Crypto','Gold','Land','Business','Stock'],
    datasets:[{
      data:[{{ inv_crypto }},{{ inv_gold }},{{ inv_land }},{{ inv_business }},{{ inv_stock or 0 }}],
      backgroundColor:['#B8E4C9','#FCE0A2','#D7BCE8','#F4C7B8','#A5C8E4'],
      cutout:'60%'
    }]
  },
  options:commonOpt
});
</script>


<div style="position:fixed;top:20px;right:20px;z-index:100;">
  
  <a href="{{ url_for('save_month_snapshot') }}" style="background:#92B6E8;color:white;padding:10px 16px;border-radius:6px;text-decoration:none;font-weight:600;box-shadow:0 2px 5px rgba(0,0,0,0.2);">üìú Rekap Bulanan</a>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const cols = [
    document.getElementById("col1"),
    document.getElementById("col2")
  ];
  const cards = Array.from(document.querySelectorAll("section.card"));

  // kalau layar kecil, reset semua card ke satu kontainer
  if (window.innerWidth < 900) {
    const container = document.getElementById("cardContainer");
    cards.forEach(card => container.appendChild(card));
    return; // jangan lanjut masonry
  }

  // jalankan masonry normal di layar besar
  cards.forEach((card) => {
    const shorter = cols.reduce((a, b) =>
      a.offsetHeight < b.offsetHeight ? a : b
    );
    shorter.appendChild(card);
  });
});
</script>

</body>
</html>
