{% extends "base.html" %}
{% block title %}Dashboard | BUKABOX{% endblock %}


{% block content %}
  <div class="top-container">
    <!-- ====== Summary Cards ====== -->
    {% set buffer = total_income - (total_expense + total_invest_month) %}
    <div class="summary-box">
      <div class="summary-card"><h3>Income</h3><p>{{ total_income | idr }}</p></div>
      <div class="summary-card"><h3>Expense</h3><p>{{ total_expense | idr }}</p></div>
      <div class="summary-card"><h3>Investment</h3><p>{{ total_invest_month | idr }}</p></div>
      <div class="summary-card">
        <h3>Balance</h3>
        <p>{{ buffer | idr }}</p>
      </div>
    </div>
  </div>


<div id="cardContainer" class="container masonry">
  <div class="col" id="col1"></div>
  <div class="col" id="col2"></div>
</div>

  <!-- SECTION 1 â€“ INCOME -->
  <section id="income-overview" class="card">
    <div class="block-chart">
    <div class="left">
      <canvas id="incomeChart"
  data-labels="{% if income %}{% for i in income %}{{ i.stream }}{% if not loop.last %},{% endif %}{% endfor %}{% else %}Belum ada data{% endif %}"
  data-values="{% if income %}{% for i in income %}{{ i.amount }}{% if not loop.last %},{% endif %}{% endfor %}{% else %}0{% endif %}">
</canvas>
    </div>

    <div class="right">
      <h2>Revenue Streams</h2>
      {% if session.get('logged_in') %}
      <form method="post" action="{{ url_for('add_income') }}">
        <div class="grid2">
          <input type="date" name="date" value="{{ today }}">
          <input type="text" name="stream" placeholder="Nama stream baru">
          <input type="text" name="amount" class="money" autocomplete="off" placeholder="Jumlah (IDR)">
          <input type="text" name="note" placeholder="Catatan">
          <button type="submit">Tambah</button>
        </div>
      </form>
      <form action="/cancel_last/income" method="POST" style="margin-top:8px;">
        <button type="submit" class="cancel-btn">âŸ² Batalkan Input Terakhir</button>
      </form>
  {% endif %}
    </div>
  </div>
  <table>
        <tr><th>Stream</th><th>Amount</th><th>Note</th></tr>
        {% for i in income|reverse %}
        <tr><td>{{ i.stream }}</td><td>{{ i.amount|idr }}</td><td>{{ i.note }}</td></tr>
        {% endfor %}
      </table>
  </section>

  <!-- SECTION 2 â€“ CASHFLOW -->
<section id="cashflow" class="card">
  <div class="left">
  <h2>Cashflow {{ today[:7] }}</h2>

  <div class="cash-block">
    <h3>Income : {{ total_income|idr }}</h3>
  </div>

  <div class="cash-block">
    <h3>Expenses : {{ total_expense|idr }}</h3>
    <button onclick="toggleDetail('exp-table-box')">Detail</button>
  </div>

  <!-- ðŸŸ¢ Tambahan non-destruktif: breakdown internal -->
  <div class="cash-sub">
    <p>â”€ Operasional : <strong>{{ total_expense_operasional|idr }}</strong></p>
    <p>â”€ Investment & Savings : <strong>{{ total_investment_savings|idr }}</strong></p>
  </div>

  <div class="summary-box buffer">
    <p>Active Balance :
      <span class="{{ buffer_state }}">
        {{ buffer_balance | currency_format }}
      </span>
    </p>
  </div>
</div>


  <div class="right">
    <canvas id="cashflowChart"
  data-income="{{ total_income }}"
  data-expense="{{ total_expense }}"
  data-invest="{{ total_invest_month }}"
  data-buffer="{{ buffer_balance }}">
</canvas>
    
  </div>

  <!-- ======= TABEL EXPENSE (area bawah merah) ======= -->
  <div id="exp-table-box" class="expense-box">
    <h3>Catat Pengeluaran Baru</h3>
{% if session.get('logged_in') %}
  <form method="post" action="{{ url_for('add_expense') }}">
    <div class="grid2">
      <input type="date" name="date" value="{{ today }}">
      <div class="category-group">
  <select id="categorySelect" name="category" required>
    <optgroup label="Operasional">
      <option value="Konsumsi">Konsumsi</option>
      <option value="Household">Household</option>
      <option value="Tagihan">Tagihan</option>
      <option value="Kesehatan">Kesehatan</option>
      <option value="Lain-lain">Lain-lain</option>
    </optgroup>
    <optgroup label="Investment & Savings">
      <option value="Investment crypto">Investment crypto</option>
      <option value="Dana Darurat">Dana Darurat</option>
      <option value="Loan">Loan</option>
      <option value="Paylater">Paylater</option>
    </optgroup>
    <option value="_new">+ Tambah kategori baru...</option>
  </select>
</div>
      <input type="text" name="amount" class="money" autocomplete="off" placeholder="Jumlah (IDR)" required>
      <input type="text" name="note" placeholder="Catatan opsional">
      <button type="submit">Tambah</button>
    </div>
  </form>

  <form action="/cancel_last/expense" method="POST" style="margin-top:8px;">
    <button type="submit" class="cancel-btn">âŸ² Batalkan Input Terakhir</button>
  </form>
  {% endif %}
    <table class="expense-table full-width">
      <thead>
        <tr>
          <th style="width:100px;">Tanggal</th>
          <th style="width:180px;">Kategori</th>
          <th style="width:150px;">Jumlah (IDR)</th>
          <th>Catatan</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cashflow if c.type == 'expense' %}
        <tr>
          <td>
            {% if c.date %}
              {{ c.date[8:10] }}/{{ c.date[5:7] }}/{{ c.date[2:4] }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ c.category }}</td>
          <td>{{ c.amount | idr }}</td>
          <td>{{ c.note }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card chart-card">
  <div class="chart-header">
    <h3>Cashflow Trend</h3>
  </div>
  <div class="chart-body">
    <canvas id="lineMonthlyChart"></canvas>
  </div>
</section>

<script>
  window.MONTHLY_DATA = {{ monthly|tojson }};
</script>


<!-- ðŸ’° Dana Darurat -->
<section id="emergency-fund" class="card full-width">
   <div class="emergency-summary">
    <p><strong>Total terkumpul:</strong> {{ total_emergency | currency_format }}</p>
    <p>Target 1: Rp {{ target1 | currency_format }}</p>
    
    <!-- Progress 1: terhadap target1 -->
<div class="progress-container">
  <div class="progress-bar">
    <div class="progress-fill" 
         style="width: {{ ((total_emergency / target1) * 100) if target1 else 0 }}%;
                background: linear-gradient(90deg, #f4b942, #f77f00);">
      {{ ((total_emergency / target1) * 100) | round(1) }}%
    </div>
  </div>
  <p style="font-size:12px;color:#777;margin:4px 0 0 0;">Progress 1 dari {{ target1 | currency_format }}</p>
</div>
    <p>Target 2: Rp {{ target2 | currency_format }}</p>
<!-- Progress 2: terhadap target2 -->
<div class="progress-container">
  <div class="progress-bar">
    <div class="progress-fill" 
         style="width: {{ ((total_emergency / target2) * 100) if target2 else 0 }}%;
                background: linear-gradient(90deg, #6fbf73, #2b9348);">
      {{ ((total_emergency / target2) * 100) | round(1) }}%
    </div>
  </div>
  <p style="font-size:12px;color:#777;margin:4px 0 0 0;">Progress 2 dari {{ target2 | currency_format }}</p>
</div>

  </div>
  <h2>ðŸ’° Dana Darurat</h2>
  {% if session.get('logged_in') %}
  <form method="post" action="{{ url_for('add_emergency') }}">
    <input type="date" name="date" value="{{ today }}">
    <input type="text" name="amount" class="money" placeholder="Jumlah (IDR)">
    <input type="text" name="note" placeholder="Catatan">
    <button type="submit" class="btn-green">Tambah</button>
  </form>

  <form method="post" action="{{ url_for('reduce_emergency') }}" style="margin-top:10px;">
    <input type="date" name="date" value="{{ today }}">
    <input type="text" name="amount" class="money" placeholder="Kurangi (IDR)">
    <input type="text" name="note" placeholder="Catatan pengeluaran">
    <button type="submit" class="btn-red">Kurangi</button>
  </form>

  {% endif %}
  <hr>

 

  <table class="emergency-table">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Nominal</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody>
      {% for e in emergency %}
      <tr class="{% if e.amount < 0 %}negative{% else %}positive{% endif %}">
        <td>{{ e.date }}</td>
        <td>{{ e.amount | currency_format }}</td>
        <td>{{ e.note }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>


  <!-- SECTION 3 â€“ GLOBAL INVESTMENT OVERVIEW -->
  <section id="invest-overview" class="card">
    <div class="left">
    <canvas id="investChart"
  data-crypto="{{ inv_crypto }}"
  data-gold="{{ inv_gold }}"
  data-land="{{ inv_land }}"
  data-business="{{ inv_business }}"
  data-stock="{{ inv_stock or 0 }}">
</canvas>
    </div>
    <div class="right">
      <h2>Investment Allocation</h2>
      <table>
        <tr><th>Asset Class</th><th>Total (IDR)</th></tr>
        <tr onclick="openDetail('crypto')"><td>Crypto</td><td class="clickable">{{ inv_crypto|idr }}</td></tr>
        <tr onclick="openDetail('gold')"><td>Gold</td><td class="clickable">{{ inv_gold|idr }}</td></tr>
        <tr onclick="openDetail('land')"><td>Land</td><td class="clickable">{{ inv_land|idr }}</td></tr>
        <tr onclick="openDetail('business')"><td>Business</td><td class="clickable">{{ inv_business|idr }}</td></tr>
        <tr onclick="openDetail('stock')"><td>Stock</td><td class="clickable">{{ inv_stock|idr }}</td></tr>
      </table>
    </div>
  </section>
<div style="position:fixed;top:20px;right:20px;z-index:100;">
  
  <a href="{{ url_for('save_month_snapshot') }}" style="background:#92B6E8;color:white;padding:10px 16px;border-radius:6px;text-decoration:none;font-weight:600;box-shadow:0 2px 5px rgba(0,0,0,0.2);">ðŸ“œ Rekap Bulanan</a>
</div>

  <!-- Modal Login -->
  <div id="loginModal" class="modal">
  <div class="modal-card">
    <h2>Masuk ke Dashboard</h2>
    <form id="loginForm" method="POST">
      <input type="text" name="username" placeholder="Username" required>
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">Login</button>
      <p id="loginMsg"></p>
      <p class="switch">
        Belum punya akun?
        <a href="#" id="showRegister">Daftar di sini</a>
      </p>
    </form>
  </div>
</div>

<!-- ================= REGISTER MODAL ================= -->
<div id="registerModal" class="modal">
  <div class="modal-card">
    <h2>Buat Akun Baru</h2>
    <form id="registerForm" method="POST">
      <input type="text" name="username" placeholder="Username" required>
      <input type="password" name="password" placeholder="Password" required>
      <input type="password" name="confirm" placeholder="Konfirmasi Password" required>
      <button type="submit">Daftar</button>
      <p id="registerMsg"></p>
      <p class="switch">
        Sudah punya akun?
        <a href="#" id="showLogin">Masuk di sini</a>
      </p>
    </form>
  </div>
</div>
{% endblock %}

