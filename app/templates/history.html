{% extends "base.html" %}
{% block title %}Dashboard | BUKABOX{% endblock %}


{% block content %}
<div class="container history-page">
 
<section class="chart-card">
  <div class="chart-header">
    <h3>Cashflow Trend</h3>
  </div>
  <div class="chart-body">
    <canvas id="lineMonthlyChart"></canvas>
  </div>
</section>

<script>
  window.MONTHLY_DATA = {{ monthly|tojson }};
</script>


<!-- Data untuk Chart.js -->
<script>
  window.MONTHLY_DATA = {{ monthly|tojson }};
</script>

  <a href="{{ url_for('save_month_snapshot') }}" class="btn-snapshot">ðŸ“¦ Simpan Rekap Bulan Aktif</a>

  {% if histories %}
  <table class="history-table">
    <thead>
      <tr>
        <th>Bulan</th>
        <th>Income</th>
        <th>Expense</th>
        <th>Investment</th>
        <th>Buffer</th>
        <th style="width:160px;">Aksi</th>
      </tr>
    </thead>
    <tbody>
  {% for h in histories %}
    {# â€” Normalisasi supaya aman untuk 2 bentuk data â€” #}
    {% set sum = h.summary if h.summary is defined else
                 {'income': (h.total_income or 0) if h.total_income is defined else 0,
                  'expense': (h.total_expense or 0) if h.total_expense is defined else 0,
                  'investment': (h.total_investment or 0) if h.total_investment is defined else 0} %}
    {% set buffer_val = (sum.income or 0) - ((sum.expense or 0) + (sum.investment or 0)) %}

    <tr>
      <td><b>{{ h.month }}</b></td>
      <td>{{ sum.income | idr }}</td>
      <td>{{ sum.expense | idr }}</td>
      <td>{{ sum.investment | idr }}</td>
      <td>
        <span style="color:{{ '#d33f3f' if buffer_val < 0 else '#1b9e5a' }};">
          {{ buffer_val | idr }}
        </span>
      </td>
      <td>
        <a href="{{ url_for('history_detail', month=h.month) }}" class="btn btn-detail">Detail</a>
        <a href="{{ url_for('export_history_pdf', month=h.month) }}" class="btn btn-pdf">PDF</a>
      </td>
    </tr>
  {% endfor %}
</tbody>

  </table>
  {% else %}
  <div class="no-data">
    ðŸ“­ <b>Belum ada data rekap bulanan tersimpan</b><br><br>
    Rekap akan muncul otomatis setelah kamu menutup bulan aktif di dasbor utama.
  </div>
  {% endif %}
</div>
{% endblock %}
